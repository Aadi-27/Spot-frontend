<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <link href="index.css" rel="stylesheet">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.js"></script>
 
    <script src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-map.js?key=48wp5C8UqoqQNbiKsbCrAAET6OybgksY"></script>
    <script src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-geocoding.js?key=48wp5C8UqoqQNbiKsbCrAAET6OybgksY"></script>
</head>
  <body>
    <h1 class="header">Save Bookmark</h1>
        <div id="map" ></div>
        
        <div class="save-box">
          <form class="save-form">
              <input class="textb" type="text" name="" placeholder="Location" />
              <a class="save-btn" href="#">
                  <i class="fas fa-plus" style="font-size: 24px;"></i>
              </a>            
          </form>
        </div>
        <div class="show-locations">
          <a href="logs/index.html">View Saved Locations</a>
        </div>
        
  </body>
  <script src="../index.js"></script>
  <script>
    
    //Bindings
    const searchForm = document.querySelector('.save-form');
    const searchBox = document.querySelector('.textb');
    const submitBtn = document.querySelector('.save-btn');

    const markerSize = {'sm': [28, 35], 'md': [35, 44], 'lg': [42, 53]};
    const markerAnchor = {'sm': [14, 35], 'md': [17, 44], 'lg': [21, 53]};
    const markerPopupAnchor = {'sm': [1, -35], 'md': [1, -44], 'lg': [2, -53]};

    const mediumMarker = L.icon({
      iconUrl: 'https://assets.mapquestapi.com/icon/v2/marker-sm.png',
      iconRetinaUrl: 'https://assets.mapquestapi.com/icon/v2/marker-sm@2x.png',
      iconSize: markerSize.sm,
      iconAnchor: markerAnchor.sm,
      popupAnchor: markerPopupAnchor.sm
    });

   
    // async function to submit form alongwith location data to the server
    function submitForm(e) {
        e.preventDefault()
        const inputValue = e.target[0].value
       
        // this.reset();

        const lat = results.best.latlng.lat
        const long = results.best.latlng.lng
        const timestamp = Date.now();
        inputValue.timestamp = timestamp;
        const data = {lat, long, inputValue, timestamp}
        const options = {
            method: 'post',
            headers: {
                "Content-Type" : "application/json"
            },
            body: JSON.stringify(data)
        }
        fetch('/', options).then((response) => {
            return response.json();
        }).then((data) => {
            if(data.result.ok == 1 && data.result.n == 1) {
                console.log('added the data into the database')
            }
        })
    }

    // creating the map with the data queired
    let popup = L.popup(),
    geocode,
    map,
    theMarker = {};

    map = L.map('map', {
        layers: MQ.mapLayer(),
        center: [ 12.907850833333336, 77.56260816666665 ],
        zoom: 10
    }).on('click', function(e) {
        popup.setLatLng(e.latlng).openOn(this);

        geocode.reverse(e.latlng);
    })

    //using geolocation API for current location
    navigator.geolocation.getCurrentPosition((pos) => {
      const coords = pos.coords;
      const lat0 = coords.latitude;
      const long0 = coords.longitude;

      map.on('click', function (e) {
        lat = e.latlng.lat;
        long = e.latlng.lng;

        // clear existing marker, show current location and add a new marker after every click event
        if(theMarker !== undefined) {
        map.removeLayer(theMarker);
        theMarker = L.marker([lat0, long0], {icon: mediumMarker}).addTo(map).bindPopup('My Location')
        };
        theMarker = L.marker([lat, long])
        .addTo(map)
      })
    });

    //current marker location data getting reverse geocoded
    geocode = MQ.geocode().on('success', function(e) {
        results = e.result

        popup.setContent(geocode.describeLocation(results.best))
    });

    document.addEventListener('submit', submitForm);
  </script>
</html>